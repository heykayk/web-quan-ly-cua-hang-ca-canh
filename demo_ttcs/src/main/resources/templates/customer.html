<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>khach hang</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
  <link rel="stylesheet" href="/css/customer.css">
</head>

<body>
  <div class="main">
    <div class="navbar-menu">
      <div class="menu" style="margin: 0 10%">
        <nav class="navbar navbar-expand-lg">
          <div class="container-fluid" style="
                background-color: #198754;
                border: 1px solid #198754;
                border-radius: 16px;
              ">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo01"
              aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
              <a class="navbar-brand" href="/trang_chu" style="font-weight: 600; color: #fff">TRANG CHỦ</a>
              <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/hang-hoa"
                    style="font-weight: 600; color: #fff">HÀNG HÓA</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/customer"
                    style="font-weight: 600; color: #fff">KHÁCH HÀNG</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/hoa_don" style="font-weight: 600; color: #fff">HÓA
                    ĐƠN</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link active" aria-current="page" href="/ban_hang"
                    style="font-weight: 600; color: #fff">BÁN HÀNG</a>
                </li>
              </ul>
              <a class="nav-link active" aria-current="page" href="/logout"
                style="font-weight: 600; color: #fff; margin-right: 20px">
                ĐĂNG XUẤT</a>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <div class="content">
      <div class="slide-bar">
        <h4>Khách Hàng</h4>

        <div class="search-client margintop-30px">
          <div class="d-flex">
            <input class="form-control me-2" type="search" placeholder="Số điện thoại, Tên" aria-label="Search"
              id="search-input" />
            <button class="btn btn-outline-success" type="submit">
              Search
            </button>
          </div>
        </div>

        <div class="dof-client margintop-30px">
          <h style="padding-left: 20px; font-size: 20px; font-weight: 400">Sinh Nhật</h>

          <a href="#"><input type="button" value="Sinh nhật trong tháng" class="slidebar-btn" onclick="searchDob()"/>
          </a>
        </div>

        <div class="rank-client margintop-30px">
          <h style="padding-left: 20px; font-size: 20px; font-weight: 400">Điểm số</h>
          <table>
            <tr>
              <th>Họ và tên</th>
              <td th:text = ${name}> <td/>
            </tr>
            <tr>
              <th>Số điện thoại</th>
              <td th:text = ${phoneNumber}> <td/>
            </tr>
            <tr>
              <th>Điểm đã tích</th>
              <td th:text = ${rewardPoint}> <td/>
            </tr>
          </table>
        </div>

        <div class="add-new-client margintop-30px">
            <button value="Thêm khách hàng" class="slidebar-btn js-uppdate-client">
              Thêm khách hàng
            </button>
        </div>
      </div>

      <div class="slide-client">
        <div class="page-client">
          <table class="table-client">
            <thead>
              <tr style="
                    background-color: #198754;
                    color: #fff;
                    margin-bottom: 50px;
                  ">
                <th>Số điện thoại</th>
                <th>Tên Khách Hàng</th>
                <th>Ngày Sinh</th>
                <th>Giới Tính</th>
                <th>ĐiểmTích Lũy</th>
              </tr>
            </thead>
            <tbody id="book-rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal js-modal">
    <div class="box-infor js-modal-box-infor">
      <form action="" class="form-infor">
        <div class="width-100 margin-height">
          <label for="" class="margin-height">Tên khách hàng</label>
          <br />
          <input class="size-box" type="text" name="" id="cus_name" required />
        </div>

        <div class="width-100 margin-height">
          <label for="" class="margin-height ">Số điện thoại</label>
          <br />
          <input class="size-box" type="text" name="" id="cus_phone" required />
        </div>

        <div class="width-100 margin-height">
          <label for="" class="margin-height">Ngày sinh</label>
          <br />
          <input class="size-box" type="date" name="" id="cus_dob" required />
        </div>

        <div class="width-100 margin-height">
          <label for="" class="margin-height">Giới tính</label>
          <br />
          <select class="size-box margin-height" id = "cus_sex">
            <option value="Nữ">Nữ</option>
            <option value="Nam">Nam</option>
          </select>

          <div class="add-btn">
            <input type="submit" style="
                  width: 30%;
                  margin-top: 15px;
                  margin-right: 5%;
                  margin-left: 5%;
                " class="btn btn-success padding-btn" 
                id = "saveButton" value="Lưu" />
            <button type="submit" style="width: 30%; margin-top: 15px; margin-left: 10%"
              class="btn btn-danger padding-btn js-modal-close">
              Hủy
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    const updates = document.querySelectorAll(".js-uppdate-client");
    const modal = document.querySelector(".js-modal");
    const modalClose = document.querySelector(".js-modal-close");
    const modalBoxInfor = document.querySelector(".js-modal-box-infor");
    const searchCusInput = document.getElementById("search-input");
    const saveButton = document.getElementById("saveButton");
    const api_url = "/list_cus";

    function showAddNewClient() {
      modal.classList.add("open");
    }
    
    function hideAddNewClient() {
   	document.getElementById("cus_name").value = null;
     document.getElementById("cus_phone").value = null;
     document.getElementById("cus_dob").value = null;
     document.getElementById("cus_sex").value = null;
      modal.classList.remove("open");
    }
    
    for (const update of updates) {
      update.addEventListener("click", showAddNewClient);
    }

    modalClose.addEventListener("click", hideAddNewClient);

    modal.addEventListener("click", hideAddNewClient);
    modalBoxInfor.addEventListener("click", function (event) {
      event.stopImmediatePropagation();
    });
    
    saveButton.addEventListener("click", sendData);
    
    function sendData() {
      console.log("hello World")
   	  const modal = document.getElementById("modal");
   	    name = document.getElementById("cus_name").value;
        phone_number = document.getElementById("cus_phone").value;
        dob = document.getElementById("cus_dob").value;
        sex = document.getElementById("cus_sex").value;
   	    const data = {
   	      name: name, 
          phone_number: phone_number,
          dob: dob,
          sex: sex
   	    };


   	    fetch("/saveCustomer", {
   	      method: "POST",
   	      headers: {
   	        "Content-Type": "application/json",
   	      },
   	      body: JSON.stringify(data),
   	    })
   	      .then((response) => response.json())
   	      .then((responseData) => {
   	        // Xử lý phản hồi từ backend (nếu cần)
   	        console.log(responseData);
   	      })
   	      .catch((error) => {
   	        // Xử lý lỗi (nếu có)
   	        console.error(error);
   	      });
   	 	window.location.href = "http://localhost:8080/customer";
   	 hideAddNewClient()
   	  }

    async function getapi(url) {
      const response = await fetch(url);
      const data = await response.json();
      console.log(data);
      show(data);
    }

    getapi(api_url);

    searchCusInput.addEventListener("keyup", function (event) {
      searchCus(searchCusInput.value);
    });

    function searchCus(query) {
      // Gửi yêu cầu tìm kiếm đến API server
      const xhr = new XMLHttpRequest();
      const url = `/search?q=${query}`;

      xhr.open("GET", url, true);

      xhr.onreadystatechange = function () {
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
          const customers = JSON.parse(this.responseText);
          show(customers);
        }
      };
      xhr.send();
    }

    function searchDob() {
      const xhr = new XMLHttpRequest();
      const url = `/searchDob`;

      xhr.open("GET", url, true);

      xhr.onreadystatechange = function () {
        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
          const customers = JSON.parse(this.responseText);
          console.log("hello");
          show(customers);
          // Hiển thị danh sách đối tượng trong giao diện người dùng
          // ...
        }
      };

      xhr.send();
    }

    function show(data) {
      let tab = ``;

      for (let cus of data) {
        tab += `<tr>
	                <td>${cus.phone_number}</td>
	                <td class="table-name-client">${cus.name}</td>
	                <td>${cus.dob}</td>
	                <td>${cus.sex}</td>
	                <td>${cus.reward_points}</td>
	                </tr>`;
      }
      document.getElementById("book-rows").innerHTML = tab;
    }
  </script>
</body>

</html>